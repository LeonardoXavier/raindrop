<!DOCTYPE html>
<html lang="en">
<head>
  <title>settings</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">

  <!--<link type="text/css" rel="stylesheet" href="/raindrop/rd_list/index.css">-->
  <link type="text/css" rel="stylesheet" href="index.css">

  <script charset="utf-8" src="/_utils/script/jquery.js?1.3.1"></script>
  <script charset="utf-8" src="/_utils/script/jquery.couch.js?0.9.0"></script>

  <script type="text/javascript">
  // Simple JavaScript Templating
  // John Resig - http://ejohn.org/ - MIT Licensed
  (function(){
    var cache = {};
   
    this.tmpl = function tmpl(str, data){
      // Figure out if we're getting a template, or if we need to
      // load the template - and be sure to cache the result.
      var fn = !/\W/.test(str) ?
        cache[str] = cache[str] ||
          tmpl(document.getElementById(str).innerHTML) :
       
        // Generate a reusable function that will serve as a template
        // generator (and which will be cached).
        new Function("obj",
          "var p=[],print=function(){p.push.apply(p,arguments);};" +
         
          // Introduce the data as local variables using with(){}
          "with(obj){p.push('" +
         
          // Convert the template into pure JavaScript
          str
            .replace(/[\r\t\n]/g, " ")
            .split("<%").join("\t")
            .replace(/((^|%>)[^\t]*)'/g, "$1\r")
            .replace(/\t=(.*?)%>/g, "',$1,'")
            .split("\t").join("');")
            .split("%>").join("p.push('")
            .split("\r").join("\\'")
        + "');}return p.join('');");
     
      // Provide some basic currying to the user
      return data ? fn( data ) : fn;
    };
  })();
  </script>

  <script id="imapAccountTemplate" type="text/html">
    <form id="<%=id%>" class="account <%=kind%>">
      <strong class="name">IMAP</strong>
      <span class="url"><%=host%></span>
      <a editid="<%=id%>" docid="<%=_id%>" class="delete"></a>
      <table class="login">
        <tr>
          <td><label for="imap-username">username:</label></td>
          <td><input type="text" name="imap-username" value="<%=username%>"></td>
        </tr>
        <tr>
          <td><label for="password">password:</label></td>
          <td><input type="password" name="password" value="password"></td>
        </tr>
        <tr>
          <td><label for="host">host</label></td>
          <td><input type="text" name="host" value="<%=host%>"></td>
        </tr>
        <tr>
          <td><label for="port">port</label></td>
          <td><input type="text" name="port" value="<%=port%>"></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
          <td style="text-align:right;">
            <button>ok &#x2714;</button>
          </td>
        </tr>
      </table>
    </form>
  </script>

  <script id="twitterAccountTemplate" type="text/html">
    <form id="<%=id%>" class="account <%=kind%>">
      <strong class="name">Twitter</strong>
      <a editid="<%=id%>" docid="<%=_id%>" class="delete"></a>
      <span class="url">twitter.com<span class="twitter.com"><%=username%></span></span>
      <table class="login">
        <tr>
          <td><label for="twitter-username">username:</label></td>
          <td><input type="text" name="twitter-username" value="<%=username%>"></td>
        </tr>
        <tr>
          <td><label for="password">password:</label></td>
          <td><input type="password" name="password" value="password"></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
          <td style="text-align:right;">
            <button>ok &#x2714;</button>
          </td>
        </tr>
      </table>
    </form>
  </script>

  <script id="gmailAccountTemplate" type="text/html">
    <form id="<%=id%>" class="account <%=kind%>">
      <strong class="name">Gmail</strong>
      <a editid="<%=id%>" docid="<%=_id%>" class="delete"></a>
      <span class="url">mail.google.com</span>
      <table class="login">
        <tr>
          <td><label for="gmail-username">username:</label></td>
          <td><input type="text" name="gmail-username" value="<%=username%>"></td>
        </tr>
        <tr>
          <td><label for="password">password:</label></td>
          <td><input type="password" name="password" value="password"></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
          <td style="text-align:right;">
            <button>ok &#x2714;</button>
          </td>
        </tr>
      </table>
    </form>
  </script>

  <script id="skypeAccountTemplate" type="text/html">
    <form id="<%=id%>" class="account <%=kind%>">
      <strong class="name">Skype</strong>
      <span class="url"><%=username%></span>
      <a editid="<%=id%>" docid="<%=_id%>" class="delete"></a>
      <table class="login">
        <tr>
          <td><label for="skype-username">username:</label></td>
          <td><input type="text" name="skype-username" value="<%=username%>"></td>
        </tr>
        <tr>
          <td><label for="password">password:</label></td>
          <td><input type="password" name="password" value="password"></td>
        </tr>
        <tr>
          <td>&nbsp;</td>
          <td style="text-align:right;">
            <button>update</button>
          </td>
        </tr>
      </table>
    </form>
  </script>

  <script type="text/javascript">
    var db = $.couch.db("raindrop");
    var docs = [];

    $(document).ready(function() {
      var options = {
        key : [ "rd.core.content", "schema_id", "rd.account"],
        reduce : false,
        include_docs: true,
        success : function(resp) {
          for each (var row in resp.rows) {
            var doc = row.doc;
            /* cache this result in our GLOBAL var... */
            docs.push(doc); 
            var kind = doc.kind || doc.proto;
            if (!document.getElementById(kind + "AccountTemplate")) {
              continue;
            }
            try {
              var account = tmpl(kind + "AccountTemplate", doc);
              $("#settings").append(account);

              /* onDeleteClick */
              $("#"+doc.id+ " a.delete").click(function(evt) {
                if (confirm("Delete this account?")) {
                  var docid = $(evt.originalTarget).attr("docid");
                  var _doc = null;
                  for ( var i in docs ) {
                    if ( docid == docs[i]._id ) {
                      _doc = docs[i];
                      break;
                    }
                  }
                  var delOptions = {
                    success : function(resp) {
                        document.location.reload();
                      }
                  };
                  db.removeDoc(_doc, delOptions);
                }
              });
            } catch(e) { console.log("template error", e); }
          }
          if (! docs.some(function(e) { return e.kind == "gmail"; })) {
            var kind = "gmail";
            var account = tmpl(kind + "AccountTemplate", { _id : "", id : "", kind : "", username : "", password : "" });
            $("#settings").append(account);
          }
          if (! docs.some(function(e) { return e.kind == "twitter"; })) {
            var kind = "twitter";
            var account = tmpl(kind + "AccountTemplate", { _id : "", id : "", kind : "", username : "", password : "" });
            $("#settings").append(account);
          }
        },
        error : function(resp) { alert(resp); }
      }

      db.view("raindrop!content!all/megaview", options);
    });
  </script>
</head>
<body class="settings">
  <div id="wrap">
    <ul id="settings"></ul>
    <div class="note">*more networks will be added in the near future</div>
    <a href="#close" class="close" onclick="parent.postMessage('settings-done', '*')"></a>

  </div>
</body>
</html>
